{
    "contents" : "#' get mean rainfall bar plot of the input dataset\n#' \n#' @param dataset A list containing different information, should be the result of reading netcdf file using\n#' \\code{library(ecomsUDG.Raccess)}, e.g., \\code{loadGridData{ecomsUDG.Raccess}}\n#' @param method A string showing the calculating method of the input time series. More information\n#' please refer to the details.\n#' @param output A string showing the type of the output, if \\code{output = 'ggplot'}, the returned \n#' data can be used in ggplot and \\code{getPreciBar_comb()}; if \\code{output = 'plot'}, the returned data is the plot containing all \n#' layers' information, and can be plot directly or used in grid.arrange; if not set, the data\n#' will be returned.\n#' @param plotRange A boolean showing whether the range will be plotted.\n#' @param member A number showing which member is selected to get, if the dataset has a \"member\" dimension. Default\n#' is NULL, if no member assigned, and there is a \"member\" in dimensions, the mean value of the members will be\n#' taken.\n#' @param ... \\code{title, x, y} showing the title and x and y axis of the plot.\n#' @details\n#' There are following methods to be selected, \n#' \"annual\": annual rainfall of each year is plotted.  \n#' \"winter\", \"spring\", \"autumn\", \"summer\": seasonal rainfall of each year is plotted.\n#' Month(number 1 to 12): month rainfall of each year is plotted, e.g. march rainfall of each year.\n#' \"meanMonthly\": the mean monthly rainfall of each month over the whole period.\n#' \n#' #Since \"winter\" is a crossing year, 12, 1, 2, 12 is in former year, and 1, 2 are in latter year.\n#' #so winter belongs to the latter year.\n#' \n#' \n#' \n#' @examples\n#' #gridData provided by package is the result of \\code{loadGridData{ecomsUDG.Raccess}}\n#' data(tgridData)\n#' b1 <- getPreciBar(tgridData, method = 'annual')\n#' b2 <- getPreciBar(tgridData, method = 'meanMonthly')\n#' \n#' @return The calculated mean value of the input time series and the plot of the result.\n#' @export\ngetPreciBar <- function(dataset, method, output = 'data', plotRange = TRUE, member = NULL, ...) {\n  \n  \n  #check input dataset\n  checkWord <- c('Data', 'xyCoords', 'Dates')\n  if (any(is.na(match(checkWord, attributes(dataset)$names)))) {\n    stop('Input dataset is incorrect, it should contain \"Data\", \"xyCoords\", and \"Dates\", \n          check help for details.')\n  }\n  \n  startTime <- as.POSIXlt(dataset$Dates$start, tz = 'GMT')\n  yearIndex <- startTime$year + 1900\n  monthIndex <- startTime$mon + 1\n  data <- dataset$Data\n\n  # Dimension needs to be arranged. Make sure first and second dimension is lat and lon.\n  att <- attributes(data)$dimensions\n  dimIndex <- seq(1, length(att))\n  dimIndex1 <- match(c('lat', 'lon', 'time'), att)# match can apply to simple cases\n  dimIndex2 <- dimIndex[-dimIndex1]# choose nomatch\n  \n  \n  data <- aperm(data, c(dimIndex1, dimIndex2))\n  attributes(data)$dimensions <- att[c(dimIndex1, dimIndex2)]\n  \n  # Because in the following part, only 3 dimensions are allowed, so data has to be processed.\n  if (is.null(member) & any(attributes(data)$dimensions == 'member')) {\n    dimIndex3 <- which(attributes(data)$dimensions != 'member')\n    data <- apply(data, MARGIN = dimIndex3, FUN = mean, na.rm = TRUE)\n  } else if (any(attributes(data)$dimensions == 'member')) {\n    dimIndex3 <- which(attributes(data)$dimensions == 'member')\n    data <- chooseDim(data, dimIndex3, member, drop = TRUE)\n  }\n  \n  TS <- apply(data, MARGIN = 3, FUN = mean, na.rm = TRUE) \n    \n  if (method == 'meanMonthly') {\n    monthlypreci <- tapply(TS, INDEX = list(yearIndex, monthIndex), FUN = sum, na.rm = TRUE)\n    meanMonthlyPreci <- apply(monthlypreci, MARGIN = 2, FUN = mean, na.rm = TRUE)\n    \n    title <- 'Mean Monthly Precipitation'\n    xlab <- 'Month'\n    \n    plotPreci <- data.frame(Index = month.abb[1:12], Preci = meanMonthlyPreci)\n    \n    # Here factor has to be reassigned, to keep the original order, or it will be reordered.\n    plotPreci$Index <- factor(plotPreci$Index, levels = plotPreci$Index, ordered = TRUE)\n    \n    if (plotRange) {\n      maxValue <- apply(monthlypreci, MARGIN = 2, FUN = max, na.rm = TRUE)\n      minValue <- apply(monthlypreci, MARGIN = 2, FUN = min, na.rm = TRUE)\n      \n      plotPreci$maxValue <- maxValue\n      plotPreci$minValue <- minValue\n      \n      ylim <- c(0,max(maxValue, na.rm = TRUE) * 1.1)\n      \n    } else {\n      ylim <- c(0,max(meanMonthlyPreci, na.rm = TRUE) * 1.1)\n    }\n    \n    \n  } else if (method == 'annual') {  \n    \n    annualPreci <- tapply(TS, INDEX = yearIndex, FUN = sum, na.rm = TRUE)\n    title <- 'Annual Precipitation'\n    xlab <- 'Year'\n    plotName <- names(annualPreci)\n    \n    plotPreci <- data.frame(Index = names(annualPreci), Preci = annualPreci)\n    plotPreci$Index <- factor(plotPreci$Index, levels = plotPreci$Index, ordered = TRUE)\n    \n    ylim <- c(0, max(annualPreci, na.rm = TRUE) * 1.1)\n    \n  } else if (is.numeric(method)) {\n    \n    month <- method\n    monthlyPreci <- tapply(TS, INDEX = list(yearIndex, monthIndex), FUN = sum)[, month]\n    \n    plotPreci <- data.frame(Index = names(monthlyPreci), Preci = monthlyPreci)\n    plotPreci$Index <- factor(plotPreci$Index, levels = plotPreci$Index, ordered = TRUE)\n    \n    title <- paste(month.abb[month], 'Precipitation over Whole Period', sep = ' ')\n    xlab <- 'Year'\n    ylim <- c(0, max(monthlyPreci, na.rm = TRUE) * 1.1)\n    \n  } else if (method == 'spring') {   \n    \n    seasonalPreci <- getMeanPreci(TS, method = 'spring', yearIndex = yearIndex,\n                              monthIndex = monthIndex, fullResults = TRUE)\n    plotPreci <- data.frame(Index = names(seasonalPreci), Preci = seasonalPreci)\n    plotPreci$Index <- factor(plotPreci$Index, levels = plotPreci$Index, ordered = TRUE)\n    \n    title <- paste('Spring', 'Precipitation over Whole Period', sep = ' ')\n    xlab <- 'Year'\n    ylim <- c(0, max(seasonalPreci, na.rm = TRUE) * 1.1)\n    \n    \n  } else if (method == 'summer') {\n    \n    seasonalPreci <- getMeanPreci(TS, method = 'summer', yearIndex = yearIndex,\n                                  monthIndex = monthIndex, fullResults = TRUE)\n    plotPreci <- data.frame(Index = names(seasonalPreci), Preci = seasonalPreci)\n    plotPreci$Index <- factor(plotPreci$Index, levels = plotPreci$Index, ordered = TRUE)\n    \n    title <- paste('Summer', 'Precipitation over Whole Period', sep = ' ')\n    xlab <- 'Year'\n    ylim <- c(0, max(seasonalPreci, na.rm = TRUE) * 1.1)\n    \n    \n  } else if (method == 'autumn') {\n    \n    seasonalPreci <- getMeanPreci(TS, method = 'autumn', yearIndex = yearIndex,\n                                  monthIndex = monthIndex, fullResults = TRUE)\n    plotPreci <- data.frame(Index = names(seasonalPreci), Preci = seasonalPreci)\n    plotPreci$Index <- factor(plotPreci$Index, levels = plotPreci$Index, ordered = TRUE)\n    \n    title <- paste('Autumn', 'Precipitation over Whole Period', sep = ' ')\n    xlab <- 'Year'\n    ylim <- c(0, max(seasonalPreci, na.rm = TRUE) * 1.1)\n    \n  } else if (method == 'winter') {\n    \n    seasonalPreci <- getMeanPreci(TS, method = 'winter', yearIndex = yearIndex,\n                                  monthIndex = monthIndex, fullResults = TRUE)\n    plotPreci <- data.frame(Index = names(seasonalPreci), Preci = seasonalPreci)\n    plotPreci$Index <- factor(plotPreci$Index, levels = plotPreci$Index, ordered = TRUE)\n    \n    title <- paste('Winter', 'Precipitation over Whole Period', sep = ' ')\n    xlab <- 'Year'\n    ylim <- c(0, max(seasonalPreci, na.rm = TRUE) * 1.1)\n    \n  } else {\n    stop(paste('No method called \"', method, '\", check help for information'))\n  }\n  \n  \n  xlim <- c(0, length(rownames(plotPreci))) \n  meanValue <- round(mean(plotPreci$Preci, na.rm = TRUE), 2)\n  medianValue <- round(median(plotPreci$Preci,na.rm = TRUE), 2)\n  plotMean <- paste('Mean', ' = ', meanValue)\n  plotMedian <- paste('Median', ' = ', medianValue)\n  \n  plotMax <- round(max(plotPreci$Preci, na.rm = TRUE), 2)\n  plotMin <- round(min(plotPreci$Preci, na.rm = TRUE), 2)\n  word <- paste('\\n\\n', paste(' Max', '=', plotMax), ',', paste('Min', '=', plotMin), ',',\n                plotMean, ',', plotMedian)\n  \n  xlab <- paste(xlab, word)\n  \n  theme_set(theme_bw())\n  \n  mainLayer <- with(plotPreci, {\n    ggplot(plotPreci) +\n    geom_bar(aes(x = Index, y = Preci), stat = 'identity', colour = 'black', fill = 'cyan', width = .6) +\n    xlab(xlab) +\n    ylab('Precipitation (mm)') +\n    ggtitle(title) +\n    labs(empty = NULL, ...) +#in order to pass \"...\", arguments shouldn't be empty.\n    theme(plot.title = element_text(size = rel(1.3), face = 'bold'),\n          axis.title.x = element_text(size = rel(1.2)),\n          axis.title.y = element_text(size = rel(1.2))) +\n#    geom_text(x = min(xlim) + 0.95 * (max(xlim) - min(xlim)), y = min(ylim) + 0.15 * (max(ylim) - min(ylim)),\n#              label = word)+\n    geom_hline(yintercept = meanValue) +\n    geom_text(x = min(xlim) + 0.3 * (max(xlim) - min(xlim)), y = meanValue + 3, vjust = 0, label = 'mean') +\n    geom_hline(yintercept = medianValue, colour = 'red') +\n    geom_text(x = min(xlim) + 0.6 * (max(xlim) - min(xlim)), y = medianValue + 3, vjust = 0,\n              label = 'median', colour = 'red')\n  })\n  \n\n  if (plotRange) {\n    if (is.null(plotPreci$maxValue)) {\n      message('There is no plotRange for this method')\n      print(mainLayer)\n    } else {\n      rangeLayer <- with(plotPreci, {\n        geom_errorbar(aes(x = Index, ymax = maxValue, ymin = minValue), width = 0.3)\n      })       \n      print(mainLayer + rangeLayer)\n    }\n    \n  } else {\n    print(mainLayer)\n  } \n  \n  if (output == 'plot') {\n    return(mainLayer)\n  } else if (output == 'ggplot') {\n    plotPreci$Name <- rep(title, dim(plotPreci)[1])\n    return(plotPreci)\n  } else {\n    return(plotPreci)\n  }\n}\n\n\n#' Combine bars together\n#' @param ... different barplots generated by \\code{getPreciBar(, output = 'ggplot')}, refer to details.\n#' @details\n#' ..., representing different ouput generated by \\code{getPreciBar(, output = 'ggplot')}, they \n#' have to be of the same type, e.g., \n#' 1. Jan precipitation of different years, Feb precipitation of different years, and... \n#' They are both monthly precipitation, and they share x axis.\n#' \n#' 2. Mean monthly precipitation of different dataset. e.g., long term mean monthly precipitation\n#' and short term mean monthly precipitation. They are both mean monthly precipitation.\n#' \n#' @param nrow A number showing the number of rows.\n#' @param list If input is a list containing different ggplot data, use l\\code{list = inputlist}.\n#' @return A combined barplot.\n#' @examples\n#' \n#' data(tgridData)# the result of \\code{loadGridData{ecomsUDG.Raccess}}\n#' #output type of getPreciBar() has to be 'ggplot'.\n#' b1 <- getPreciBar(tgridData, method = 2, output = 'ggplot')\n#' b2 <- getPreciBar(tgridData, method = 3, output = 'ggplot')\n#' \n#' getPreciBar_comb(b1, b2)\n#' \n#' @export\n#' @import ggplot2\ngetPreciBar_comb <- function(..., list = NULL, nrow = 1) {\n  if (!is.null(list)) {\n    data_ggplot <- do.call('rbind', list)\n  } else {\n    \n    bars <- list(...)\n    data_ggplot <- do.call('rbind', bars)\n  }\n\n  data_ggplot$Name <- factor(data_ggplot$Name, levels = data_ggplot$Name, ordered = TRUE)\n  \n  theme_set(theme_bw())\n  \n  mainLayer <- with(data_ggplot, {\n    mainLayer <- ggplot(data_ggplot)+\n      geom_bar(aes(x = Index, y = Preci),fill = 'cyan', stat = 'identity', colour = 'black', width = .6)+\n      facet_wrap( ~ Name, nrow = nrow)\n  })\n\n  \n  suppressWarnings(print(mainLayer))\n}\n\n",
    "created" : 1435749854688.000,
    "dirty" : false,
    "encoding" : "ASCII",
    "folds" : "",
    "hash" : "2834076415",
    "id" : "89993247",
    "lastKnownWriteTime" : 1435702370,
    "path" : "~/hyfo/R/getPreciBar.R",
    "project_path" : "R/getPreciBar.R",
    "properties" : {
    },
    "source_on_save" : false,
    "type" : "r_source"
}