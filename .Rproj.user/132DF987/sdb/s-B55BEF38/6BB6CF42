{
    "contents" : "library(hyfo)\nlibrary(reshape2)\nlibrary(ggplot2)\nrequire(ecomsUDG.Raccess)\nloginECOMS_UDG(\"Yuanchao\",\"abcd1234\")\nlibrary(downscaleR)\n\n############################# Weighed Rainfall Extended streamflow ###########################\n\n# calculating the mean precipitation on the catchment. since in each catchment, the rainfall is\n#weighted\nfilePath <- file.choose()\na <- dget(\"C:\\\\DHI_Projects\\\\11811405\\\\Seasonal_Forecasting\\\\Data\\\\From_website_realtime\\\\totalPreci_catchment_stations.txt\")\na2 <- extractPeriod(a, comm = T)\na3_o <- list2Dataframe(a2)\na3 <- fillGap(a3_o)\n\n# Rainfall situation of the catchment.\ngetAnnual(a)\ngetAnnual(dataframe = a3_o)\ngetAnnual(dataframe = a3)\n\n# new factor Calculate the weighted rainfall\nDCAT1 <- 0.111 * a3[2] + 0.124 * a3[3] + 0.542 * a3[6] + 0.227 * a3[4] + 0.166 * a3[5]\nANA <- 0.265 * a3[2] + 0.785 * a3[3]\nDCAT2 <- 0.111 * a3[2] + 0.124 * a3[3] + 0.542 * a3[6] + 0.227 * a3[4] + 0.166 * a3[5]\nERE <- 0.111 * a3[2] + 0.124 * a3[3] + 0.542 * a3[6] + 0.227 * a3[4] + 0.166 * a3[5]\nDSC <- 0.111 * a3[2] + 0.124 * a3[3] + 0.542 * a3[6] + 0.227 * a3[4] + 0.166 * a3[5]\n\n\n# old factor\n# DCAT1 <- 0.098 * a3[2] + 0.111 * a3[3] + 0.472 * a3[6] + 0.202 * a3[4] + 0.148 * a3[5]\n# ANA <- 0.328 * a3[2] + 0.972 * a3[3]\n# DCAT2 <- 0.098 * a3[2] + 0.111 * a3[3] + 0.472 * a3[6] + 0.202 * a3[4] + 0.148 * a3[5]\n# ERE <- 0.098 * a3[2] + 0.111 * a3[3] + 0.472 * a3[6] + 0.202 * a3[4] + 0.148 * a3[5]\n# DSC <- 0.098 * a3[2] + 0.111 * a3[3] + 0.472 * a3[6] + 0.202 * a3[4] + 0.148 * a3[5]\n\n\n\ntotalPre <- (DCAT1 * 1.65 + ANA * 48.85 + DCAT2 * 12.11 + ERE * 152.17 + DSC * 56.98) / \n  (1.65 + 48.85 + 12.11 + 152.17 + 56.98)\n\n\ntotalPre <- data.frame(Date = a3[1], value = totalPre)\ncolnames(totalPre) <- c('Date', 'value')\n\ngetAnnual(dataframe = totalPre)\n\n\n# plot the mean rainfall\\\n\nb <- analyzeTS(totalPre, method = 'annual')\n\n# so the dry year is 2001, wet year is 2013.\n\n\n# Analysis for dry year and wet year.\n# First take ensemble\n\ndry <- getHisEnsem(totalPre, example = c('2001-1-1', '2001-12-31'), buffer = 30, plot = 'cum', output = 'ggplot')\nwet <- getHisEnsem(totalPre, example = c('2013-1-1', '2013-12-31'), buffer = 30, plot = 'cum',output = 'ggplot')\n\ndry_cum <- data.frame(Date = dry$Date, cumsum(dry[2:ncol(dry)]))\nwet_cum <- data.frame(Date = wet$Date, cumsum(wet[2:ncol(wet)]))\n\ndry_ggplot <- melt(dry_cum, id.var = 'Date')\ndry_example <- dry_cum[c(1,5)]\n# This is used to distinguish example and the rest\n#dry_ggplot$example <- as.character(dry_ggplot$variable)\n#dry_ggplot$example[dry_ggplot$example != 'X2001.01.01' ] <- 'members'\n# \n\nwet_ggplot <- melt(wet_cum, id.var = 'Date')\n\n\n\n# change subset to see dry years and wet years.\nggplot(wet_ggplot) +\n  aes(x = Date, y = value, color = variable, group = variable) +\n  geom_line() +\n  geom_line(size = 2, data = wet_ggplot[wet_ggplot$variable == 'X2013.01.01', ])\n  \n\ncomb <- rbind(dry_ggplot, wet_ggplot)\n\nggplot(totalPre) +\n  aes(x = Date, y = value) +\n  geom_line()\n\n#####################################  system4 ############################################\n\n### bias correction???###\n\nfrc <- loadECOMS(dataset = \"System4_seasonal_15\", var = \"tp\", members = 1:3, \n                 lonLim = c(-2.4,-1.5), latLim = c(42.8,44.5), season = c(12,1,2), years = 1999:2003, leadMonth = 2, time = \"DD\")\nobs <- loadECOMS(dataset = \"WFDEI\", var = \"tp\", members = 1:5, \n                 lonLim = c(-2.4,-1.5), latLim = c(42.8,44.5), season = c(12,1,2), years = 1999:2008, leadMonth = 2, time = \"DD\")\nobs <- loadGridData(file.choose(), var = \"pr\", \n                    lonLim = c(-2.4,-1.5), latLim = c(42.8,44.5), dic = F, years = NULL)\n# Since frc grid is larger, so used as new grid.\nobs1 <- interpGridData(obs, new.grid = getGrid(frc))\nfrc1 <- biasCorrection(obs1, frc, frc, method = 'unbiasing')\n\n##################################### ESP PLOT ##############################################\n\nana <- read.table(\"C:\\\\DHI_Projects\\\\11811405\\\\Seasonal_Forecasting\\\\Data\\\\From_website_realtime\\\\Catchment_stations\\\\ANARBE_D1W1\\\\Discharge.txt\",\n                  sep = ',')\n\nere <- read.table(\"C:\\\\DHI_Projects\\\\11811405\\\\Seasonal_Forecasting\\\\Data\\\\From_website_realtime\\\\Catchment_stations\\\\Ere??ozu D2W1\\\\Discharge.txt\",\n                  sep = ',')\n\n###### generate different ensembles.\n\nstart <- seq(as.Date('2002-7-1'), length = 6, by = '1 month')\nend <- seq(as.Date('2003-7-1'), length = 6, by = '1 month')\nana_dry <- extractPeriod_dataset(ana, '1999-10-28', '2003-12-1')\n\n# Discharge comparison\ngetHisEnsem(ana_dry, example = c('2002-7-1', '2003-7-1'),plot = 'cum')# wet period before dry\ngetHisEnsem(ana_dry, example = c('2003-7-1', '2003-10-1'),plot = 'cum')# dry period\ngetHisEnsem(ana_dry, example = c('2003-1-1', '2003-12-31'),plot = 'cum')\n# precipitation\n\n\ndata <- mapply(function(x, y, z) getHisEnsem(ana_dry, example = c(x, y), name = z, plot = 'cum',output = 'ggplot'), \n               start, end, z = 1:6, SIMPLIFY = F)\n\ngetEnsem_comb(list = data, nrow = 7)\ndata <- do.call('rbind', data)\n\na <- ggplot(data) + \n  geom_line(aes(x = Date, y = value, colour = name)) + \n  facet_grid(name~ .)\nprint(a)\n\n\n#################################### Hydropower Plant #####################################\n\nfilePath <- \"C:\\\\DHI_Projects\\\\11811405\\\\Seasonal_Forecasting\\\\Data\\\\Diversion.txt\"\nhydroPower <- read.table(filePath, skip = 3)[c(1, 3, 4, 5, 6)]\nhydroPower[, 1] <- as.Date(hydroPower[, 1])\nhydroPower[hydroPower == -1e-30] <- NA\ncolnames(hydroPower) <- c('Date', 'Diversion', 'Observation', 'Water_Level', 'Simulated')\n\n\nmainLayer <- ggplot(hydroPower) +\n  geom_point(aes(x = Water_Level, y = Diversion)) +\n  coord_cartesian(xlim = c(146, 158), ylim = c(0, 2)) +\n#  geom_segment(aes(x = 0.2, y = 0, xend = 2, yend = 1.5), size = 2, color = 'blue') +\n#  geom_segment(aes(x = 2, y = 1.5, xend = 4, yend = 1.5), size = 2, color = 'blue') +\n  geom_segment(aes(x = 150, y = 0, xend = 150, yend = 2), linetype = 'twodash', size = 1) + \n  annotate('text', label = 'x = 150', x = 148, y = 1, size = 20)\n+\n  annotate('text', label = 'y = 0.8333 * x - 0.1667', x = 0.8, y = 1.2, angle = 40, size = 8)\n  \nprint(mainLayer)\n\nsimObs <- hydroPower[, c(1, 2, 5)]\nsimObs_ggplot <- melt(simObs, id.vars = 'Date')\n\nmainLayer <- ggplot(simObs_ggplot) +\n  geom_line(data = simObs_ggplot[simObs_ggplot$variable == 'Diversion', ], \n            aes(x = Date, y = value), size = 1)\nprint(mainLayer)\n\n\n####################################  Guging stations #################################\n\n\nallStations <- dget(\"C:\\\\DHI_Projects\\\\11811405\\\\Seasonal_Forecasting\\\\Data\\\\From_website_realtime\\\\totalPreci_other_stations.txt\")\ncatStations <- dget(\"C:\\\\DHI_Projects\\\\11811405\\\\Seasonal_Forecasting\\\\Data\\\\From_website_realtime\\\\totalPreci_catchment_stations.txt\")\n\nall <- c(allStations, catStations)\n\ngetAnnual(catStations)\n\ncat1 <- getPreciBar(TS = catStations[[1]], method = 'meanMonthly', output = 'ggplot')\ncat2 <- getPreciBar(TS = catStations[[2]], method = 'meanMonthly', output = 'ggplot')\ncat_comb <- getPreciBar_comb(cat1, cat2)\n#################################### Monthly Preci #####################################\n\nb <- loadGridData(filePath, \"pr\", year = NULL,latLim= c(36,43.8) , lonLim=c(-9.2,4.4) , season = NULL, dictionary=FALSE)\nbMon <- lapply(1:12, function(x) getPreciBar(b, x, output = 'ggplot'))\ngetPreciBar_comb(bMon, nrow = 3)\n",
    "created" : 1437680807606.000,
    "dirty" : false,
    "encoding" : "ASCII",
    "folds" : "",
    "hash" : "2653204690",
    "id" : "6BB6CF42",
    "lastKnownWriteTime" : 1438633339,
    "path" : "C:/DHI_Projects/11811405/Seasonal_Forecasting/R/Data_Analysis/Analysis.R",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 3,
    "source_on_save" : false,
    "type" : "r_source"
}