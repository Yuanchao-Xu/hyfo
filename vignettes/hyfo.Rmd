---
title: "hyfo Easy Start"
author: "Yuanchao Xu"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette

vignette: >
  %\VignetteIndexEntry{hyfo easy start}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{ASCII}
---
# hyfo 

#### is designed for hydrology and forecasting anaylasis, containing a number of tools including data extration, data processing and data visulization. There are two main parts in the package, as well as in this mannual:

1. Hydrology
* Providing tools from raw data extration to final precipitation data used by model.
* e.g., data extraction from file, precipitation gap filler, annual precipitation calculation.

2. Forecasting
* Providing tools from forecasting data visulization and analysis.
* e.g., get spatial maps, data analysis and bias analysis.

##### Note

* For the forecasting tools part, `hyfo` mainly focuses on the post processing of the gridData derived from forecasts or other sources. The input is a list file, usually a result from  `loadGridData{ecomsUDG.Raccess}` or `loadECOMS{ecomsUDG.Raccess}`. Pacakage`{ecomsUDG.Raccess}`is designed for getting access to different dataset, and also can load grid file (like netcdf file) directly.

* The functions end with `_anarbe` are the functions designed specially for some case in Spain, those functions mostly are about data collection of the anarbe catchment, which will be introduced in the end fo this mannual.

# 1. Hydrology

##### Note

If you are an experienced R user, and know how to read data in R, deal with dataframe, generate date and list, please start from next charpter, "1.2 Rainfall Analysis"



## 1.1 Data Preparation

### 1.1.1 Frome File

`hyfo` does provide a common tool for collecting data from different type of files, including "txt", 

"csv" and "excel", which has to be assigned to the argument `fileType`.

Now let's use internal data as an example.
```{r, fig.show='hold'}

library(hyfo)#load the package.

file <- system.file("extdata", "1999.csv", package = "hyfo")
# get the folder containing different csv (or other type) files.
folder <- strsplit(file, '1999')[[1]][1] 

# Extract and combine content from different files and in each file, the extracted zone is 
# from row 10 to row 20, Column 1 to column2.
a <- collectData(folder, fileType = 'csv', range = c(10, 20, 1,2))
str(a)
```

`a` cannot be directly inputed in `hyfo`, it still needs some process.
```{r, fig.show = 'hold', fig.height = 4, fig.width = 7}
# Check the date to see if it follows the format in ?as.Date(), if not, 
# use as.Date to convert. 
a <- data.frame(a)
#get date
date <- a[, 1]

# The original format is d/m/year, convert to formal format.
date <- as.Date(date, format = '%d/%m/%Y')
a[, 1] <- date

# Now a has become `a` time series dataframe, which is the atom element of the analysis. 
#`hyfo` deals with list containing different time series dataframe. In this example, 
#there is only one dataframe, and more examples please refer to the following chapter.
datalist <- list(a)

# Use getAnnual as an example, here since `a` is not a complete time series, 
# the result is only base on the input.
# getAnnual gives the annual precipitation of each year, 
# and will be introduced in the next chapter.
getAnnual(datalist)
```


### 1.1.2 Mannually

Following example shows a simple way to generate dataframe with start date, end date, and the value. Here in the example, `sample()` is used to generate random values, while in real case it will be a vector containing time series values.
```{r, fig.show = 'hold', fig.height = 4, fig.width = 7}
# Generate timeseries datalist. Each data frame consists of a Date and a value.
AAA <- data.frame(
  Date = seq(as.Date('1990-10-28'), as.Date('1997-4-1'), 1), # Date column
  AAA = sample(1:10, length(seq(as.Date('1990-10-28'), # value column
                                as.Date('1997-4-1'), 1)), repl = TRUE))

BBB <- data.frame(
  Date = seq(as.Date('1993-3-28'), as.Date('1999-1-1'),1), 
  BBB = sample(1:10, length(seq(as.Date('1993-3-28'), 
                                as.Date('1999-1-1'),1)), repl = TRUE))

CCC <- data.frame(
  Date = seq(as.Date('1988-2-2'), as.Date('1996-1-1'),1), 
  CCC = sample(1:10, length(seq(as.Date('1988-2-2'), 
                                as.Date('1996-1-1'),1)), repl = TRUE)) 

datalist <- list(AAA, BBB, CCC)# dput() and dget() can be used to save and load list file.
a <- getAnnual(datalist)
```



## 1.2 Rainfall Analysis

Assuming we have three gauging stations named "AAA", "BBB", "CCC", the precipitation information can be get by the following:
```{r, fig.show='hold', fig.height=4, fig.width=7}
# testdl is a datalist provided by the package as a test. 
# It's a list containing different time series.
data(testdl)
a <- getAnnual(testdl)
```

As shown above, the annual precipitation and the number of missing values are shown in the figure. Knowing how many missing values you have is alway important when calculating the mean annual precipitation. 

Now we want to get the mean annual precipitation.
```{r, fig.show='hold', fig.height=4, fig.width=7}
a <- getAnnual(testdl, output = 'mean')
a
```

Mean annual precipitation is calculated, but as we can see in the figure before, it's not reliable, since there are a lot of missing values in AAA and CCC, especially in AAA, in 1993, there are more than 30 missing values in a year. So we have to decide which is the threshold for the valid record. the default is 355, which means in a year (355 or 365 days), if the valid records (not missing) exceeds 355, then this year is taken into consideration in the mean annual preicipitation calculation.
```{r, fig.show='hold', fig.height=3, fig.width=3}
getAnnual(testdl, output = 'mean', minRecords = 300)
getAnnual(testdl, output = 'mean', minRecords = 365)
```

If you are not satisfied with the title and x axis and y axis, you can assign them yourself.
```{r, fig.show='hold', fig.height=4, fig.width=7}
a <- getAnnual(testdl, output = 'mean', title = 'aaa', x = 'aaa', y = 'aaa')
a
```

If you want to calculate annual rainfall for a single dataframe containing one time series.
```{r, fig.show='hold', fig.height=4, fig.width=7}
a <- getAnnual_dataframe(testdl[[1]])
a
```



## 1.3 Extract Common Period from Different Time Series

Now we have the general information of the precipitation, if we want to use them in a model, we have to extract the common period of them, and use the common period precipitation to analyze.
```{r, fig.show='hold', fig.height=4, fig.width=7}
testdl_new <- extractPeriod(testdl, commonPeriod = TRUE )
str(testdl_new)
```

If we want to extract data from a certain period, we can assgin start and end date.

```{r, fig.show='hold', fig.height=4, fig.width=7}
# Extract period of the winter of 1994
testdl_new <- extractPeriod(testdl, startDate = '1994-12-01', endDate = '1995-03-01' )
str(testdl_new)
```



## 1.4 Fill Gaps (rainfall data gaps)

Although we have got the precipitation of the common period, we can still see that there are some missing values inside, which we should fill.
```{r, fig.show='hold', fig.height=4, fig.width=7}
testdl_new <- extractPeriod(testdl, commonPeriod = TRUE )
a <- getAnnual(testdl_new)
a
```

First we have to transform the datalist to dataframe, which can be done by the code below:
```{r, fig.show='hold', fig.height=4, fig.width=7}
df <- list2Dataframe(testdl_new)
head(df)
```

From above, we can see that in the gauging station "AAA", there are some missing value marked as "NA". Now we are going to fill these gaps.

The gap filling is based on the correlation and linear regression between each two gauging stations, correlation table, correlation Order and Linear Coefficients are also printed when doing the calculation. Details can be found in  `?fillGap`.
```{r, fig.show='hold', fig.height=4, fig.width=7}
df_filled <- fillGap(df)
head(df_filled)
```

Default correlation period is "daily", while sometimes the daily rainfall correlation of precipitation is not so strong, we can also select the correlation period.
```{r, fig.show='hold', fig.height=4, fig.width=7}
df_filled <- fillGap(df, corPeriod = 'monthly')
head(df_filled)
df_filled <- fillGap(df, corPeriod = 'yearly')
head(df_filled)
```



## 1.5 Seasonal and Monthly Precipitation.

Sometimes we need to know not only the annual precipitation, but also the precipitation of a certain month or certain season.
```{r, fig.show='hold', fig.height=4, fig.width=7}
data(testdl)
# year and mon can be extracted from date.
TS  <- testdl[[1]]
year = as.numeric(format(TS[, 1], '%Y'))
month = as.numeric(format(TS[, 1], '%m'))

# Get the mean spring precipitation.
a <- getMeanPreci(TS[, 2], method = 'spring', yearIndex = year, monthIndex = month)
a

# Get the series of spring precipitation, set fullResults = TRUE.
a <- getMeanPreci(TS[, 2], method = 'spring', yearIndex = year, monthIndex = month,
                  fullResults = TRUE)
a

# If missing value is excluded, set omitNA = TRUE.
a <- getMeanPreci(TS[, 2], method = 'winter', yearIndex = year, monthIndex = month,
                  omitNA = TRUE, fullResults = TRUE)
a

# Get special month precipitation, e.g. march.
a <- getMeanPreci(TS[, 2], method = 3, yearIndex = year, monthIndex = month,
                  fullResults = TRUE)
a

# We can also get annual precipitation.
a <- getMeanPreci(TS[, 2], method = 'meanAnnualPreci', yearIndex = year, monthIndex = month,
                  fullResults = TRUE)
```


# 2. Forecasting

## 2.1 Plot Spatial Map

As described at the start of the mannual, `hyfo` is mainly in charge of the post processing of the forecast data. Input of `hyfo` should be the result from  `loadGridData{ecomsUDG.Raccess}` or `loadECOMS{ecomsUDG.Raccess}`. An example is included in the package. 

If we want to see the mean daily precipitation.
```{r, fig.show='hold', fig.height=4, fig.width=7}
data(tgridData)
a <- getSpatialMap(tgridData, method = 'meanAnnual')
```

There are several methods to be seleted in the function, details can be found by `?getSpatialMap`.

Sometimes there exists a great difference in the whole map, e.g., the following value, `c(100, 2, 2,6, 1,7)`, since the maximum value is too large, so in the plot, by normal plot scale, we can only recognize value 100 and the rest, it's hard for us to tell the difference between 2, 2.6, and 1.7 from the plot. In this situation, the value needs to be processed before plotting. Here `scale` provides a way to decide the plot scale.

`scale` passes the arguments to the `trans` argument in `ggplot2`. The most common scale is "sqrt" and "log10", which focus more on the minutiae. Default is "identity", which means no change to the plot scale.
```{r, fig.show='hold', fig.height=4, fig.width=7}
a <- getSpatialMap(tgridData, method = 'meanAnnual', scale = 'sqrt')
```

Here in our example, because the region is too small, and the differences is not so big, so it's not so obvious to tell from the plot. But if in a map, both dry region and wet region is included, that will be more obvious to see the difference between the plot scales.


Also, if you are not satisfied with the title, x axis and y axis, you can assgin yourself.
```{r, fig.show='hold', fig.height=4, fig.width=7}
a <- getSpatialMap(tgridData, method = 'meanAnnual', scale = 'sqrt', 
                   title = 'aaa', x = 'aaa', y = 'aaa')
```

## 2.2 Add Background (catchment and gauging stations)

The default background is the world map, while if you have other backgrounds like catchment shape file and station location file, you are welcome to import them as background.

### 2.2.1 Add catchment shape file.

Catchment shape file needs to be processed with a very simple step. It's based on the package `rgdal`, details can be found by `?shp2cat`

```{r, fig.show='hold', fig.height=4, fig.width=7}
# Use the test file provided by hyfo
file <- system.file("extdata", "testCat.shp", package = "hyfo")
cat <- shp2cat(file)
# cat is the catchment file.
```

Then the catchment file `cat` can be inputed as background.

```{r, fig.show='hold', fig.height=4, fig.width=7}
a <- getSpatialMap(tgridData, method = 'meanAnnual', catchment = cat)
```

### 2.2.2 Add station locations.

Points file needs to be read into dataframe, and special column has to be assigned, details can be found by `?getSpatialMap_mat`
```{r, fig.show='hold', fig.height=6, fig.width=7}
# Use the points file provided by hyfo
file <- system.file("extdata", "points.txt", package = "hyfo")
points <- read.table(file, header = TRUE, sep = ',' )
getSpatialMap(tgridData, method = 'winter', points = points, catchment = cat)

```

As can be seen above, the color of the points represents the elevation, the size of the points represents the value, e.g., rainfall value.








Gap filling is based on the correlation coefficient and the linear regression between each two gauging stations.









## Figures

The figure sizes have been customised so that you can easily put two images side-by-side. 

```{r, fig.show='hold', size=10}
plot(1:10)
plot(10:1)
```

You can enable figure captions by `fig_caption: yes` in YAML:

    output:
      rmarkdown::html_vignette:
        fig_caption: yes

Then you can use the chunk option `fig.cap = "Your figure caption."` in **knitr**.

## More Examples

You can write math expressions, e.g. $Y = X\beta + \epsilon$, footnotes^[A footnote here.], and tables, e.g. using `knitr::kable()`.

```{r, echo=FALSE, results='asis'}
knitr::kable(head(mtcars, 10))
```

Also a quote using `>`:

> "He who gives up [code] safety for [code] speed deserves neither."
([via](https://twitter.com/hadleywickham/status/504368538874703872))
